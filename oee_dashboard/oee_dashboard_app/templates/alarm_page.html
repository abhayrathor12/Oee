{% extends 'home.html' %}
{% load custom_filters %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/alarm.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;700&display=swap" rel="stylesheet">

<style>
    
</style>
{% endblock %}

{% block extra_js %}
<script>
    function updateCardVisibility() {
        // Get the number selected from the dropdown
        const numCards = document.getElementById('card-select').value;
        
        // Get all the error cards
        const cards = document.querySelectorAll('.error-card');
        
        // Loop through all cards and hide those that exceed the selected number
        cards.forEach((card, index) => {
            if (index < numCards) {
                card.style.display = 'block'; // Show the card
            } else {
                card.style.display = 'none'; // Hide the card  
            }
        });
    }
    
    // Call this function initially to set the correct visibility when the page loads
    updateCardVisibility();
</script>
{% endblock %}

{% block content %}
<div class="home-section">
    <h3 class="shift">Alarm Details</h3>
    
<div class="forflex">    
    <div class="container">
        <div class="dashboard">
            <div class="dashboard-header">
                <h2>Alarm Details</h2>
                <div>
                    <label for="time-period-dropdown">Select Time Period:</label>
                    <select id="time-period-dropdown" class="filter-select">
                        <option value="all">All</option>
                        <option value="today">Today</option>
                        <option value="previous_week">Previous Week</option>
                        <option value="last_month">Last Month</option>
                    </select>
                   
                </div>
                
            </div>
            

                <div class="chartfor">
                    <div class="time">
                        <canvas id="incidents-chart" width="400" height="280"></canvas>
                    </div>
                    <div class="incident">
                        <canvas id="times-chart" width="400" height="280"></canvas>
                    </div>
                </div>

            
    
        </div>
    </div>
<div class="container">
    <div class="table-header">
        <h2 class="table-title">Live Alarm</h2>
    </div>

    <div class="col-3 live-alarm-section">
        <h3 class="mb-3" style="color: var(--industrial-primary);">
            
        </h3>


        <div class="alarm-paragraph">
            {% for alarm in live_alarms %}
            <div class="alarm-detail">
                {% if alarm.status == 'critical' %}<i class="fas fa-exclamation-circle alarm-icon critical"></i>
                {% else %}<i class="fas fa-exclamation-triangle alarm-icon moderate"></i>{% endif %}
                
                At <strong>{{alarm.time}}</strong>, a <span class=" {% if alarm.status == 'critical' %}critical{% elif alarm.status == 'moderate' %}moderate{% else %}alarm-info{% endif %}">{{alarm.status}}</span> alarm was triggered for the <strong>{{alarm.name}}</strong>. 
            </div>
            {% endfor%}
        </div>
    
          </div>
    </div>

</div>

<footer class="divfooter">
    <p class="foot">Â© 2023 Copyright: TechnoViz Automation 
        <img class="imgg" src="{% static 'images/logo-.png' %}">
    </p>
</footer>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/details.js' %}"></script>
<script>
    let incidentsChart = null;
        let timesChart = null;

        function renderChart(canvasId, data, label, bgColor, borderColor) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (canvasId === "incidents-chart" && incidentsChart) {
                incidentsChart.destroy();
            } else if (canvasId === "times-chart" && timesChart) {
                timesChart.destroy();
            }
        
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item.name),
                    datasets: [{
                        label: label,
                        data: data.map(item => canvasId === "incidents-chart" ? item.occurrences : item.total_time),
                        backgroundColor: bgColor,
                        borderColor: borderColor,
                        borderWidth: 1,
                        barThickness: 20, // Fixed bar width in pixels
                        maxBarThickness: 30, // Maximum bar width
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            ticks: {
                                autoSkip: false // Prevent skipping of labels if there are many
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 5, // Set the interval between tick marks
                                callback: function (value) {
                                    return value; // Optional: Customize tick labels if needed
                                }
                            }
                        }
                    }
                }
            });
        
            if (canvasId === "incidents-chart") incidentsChart = chart;
            if (canvasId === "times-chart") timesChart = chart;
        }

        document.getElementById('time-period-dropdown').addEventListener('change', function () {
            const timePeriod = this.value;

            fetch(`/filter-alarms?time_period=${timePeriod}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        renderChart('incidents-chart', data.data.incidents, 'Occurrences', 'rgba(75, 192, 192, 0.2)', 'rgba(75, 192, 192, 1)');
                        renderChart('times-chart', data.data.times, 'Total Time (Minutes)', 'rgba(153, 102, 255, 0.2)', 'rgba(153, 102, 255, 1)');
                    }
                })
                .catch(error => console.error('Error fetching alarms:', error));
        });

        // Load initial data
        fetch('/filter-alarms?time_period=all')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    renderChart('incidents-chart', data.data.incidents, 'Occurrences', 'rgba(75, 192, 192, 0.2)', 'rgba(75, 192, 192, 1)');
                    renderChart('times-chart', data.data.times, 'Total Time (Minutes)', 'rgba(153, 102, 255, 0.2)', 'rgba(153, 102, 255, 1)');
                }
            });
    </script>
{% endblock %}